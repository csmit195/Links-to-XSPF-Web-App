<!doctype html>
<html>
  <head>
    <title>Links to XPSF Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/3.1.0/mustache.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.min.js" integrity="sha256-dPTL2a+npIonoK5i0Tyes0txCMUWZBf8cfKRfACRotc=" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.min.css" integrity="sha256-vZ3SaLOjnKO/gGvcUWegySoDU6ff33CS5i9ot8J9Czk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/theme/pastel-on-dark.min.css" integrity="sha256-VUnPtGtiUwEqD7klqFHX56HCmWuinrmYcqh3juZMnvg=" crossorigin="anonymous" />
    <link rel="stylesheet" type="text/css" href="https://meyerweb.com/eric/tools/css/reset/reset.css">
    <link href="https://fonts.googleapis.com/css?family=Poppins&display=swap" rel="stylesheet">
    
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        background-color: #1d1d1d;
        color: orange;
        font-family: Poppins, sans-serif;
      }
      body,html {
        height: 100%;
      }
      #container {
        height: 100%;
      }
      #container > aside {
        height: 45px;
      }
      #container > aside * {
        height: 45px;
        line-height: 45px;
        vertical-align: middle
      }
      #container p {
        display: inline-block;
        padding: 0 20px;
      }
      #container h1 {
        font-size: 1.2em;
        font-weight: 600890;
        display:inline-block;
        height: 40px;
        padding: 0 30px;
        line-height: 40px;
      }
      .CodeMirror {
        width: 100%;
        height: calc(100% - 45px);
      }
      #download-button {
        background-color: orange;
        color: black;
        display: inline-block;
        padding: 0 20px;
        font-weight: 100;
        text-decoration: none;
        z-index: 9999;
      }
    </style>
  </head>
  <body>    
    <section id="container">
      <aside>
        <h1>Links to XPSF Generator</h1>
        <a id="download-button" onclick="generate();" href="#">Generate</a>
        <p>Coded poorly for a one-time use, hope you use of it.</p>
      </aside>
      <textarea id="text"></textarea>
    </section>
    
    <script id="template" type="x-tmpl-mustache"><?xml version="1.0" encoding="UTF-8"?>
<playlist xmlns="http://xspf.org/ns/0/" xmlns:vlc="http://www.videolan.org/vlc/playlist/ns/0/" version="1">
  <title>{{total}} Links</title>
  <trackList>
    {{#files}}
      <track>
        {{#title}}<title>{{title}}</title>{{/title}}
        <location>{{ url }}</location>
        <extension application="http://www.videolan.org/vlc/playlist/0">
          <vlc:id>{{ id }}</vlc:id>
        </extension>
      </track>
    {{/files}}
  </trackList>
  <extension application="http://www.videolan.org/vlc/playlist/0">
    {{#files}}
      <vlc:item tid="{{ id }}"/>
    {{/files}}
  </extension>
</playlist></script>
    
    <script type="text/javascript">
      var template = $('#template');
      var CodeMirror = CodeMirror.fromTextArea($('#text')[0], {
        lineNumbers: true,
        theme: 'pastel-on-dark'
      });
      var options = {
        parseFileNames: true,
        onlyAllowParsable: false,
        removeDuplicates: {
          enable: false,
          onlyAllowYear: false
        },
        addTitles: true
      }
      
      function generate(){
        var Contents = CodeMirror.getValue();
        toastr.info('Validating Links...')
        var lines = Contents.split('\n');
        var files = [];
        var duplicates = {};
        var failed = false;
        for(var i = 0;i < lines.length;i++){
          var line = lines[i];
          if ( !isValidURL(line) ) {
						console.log('line:', i+1, ':', line);
            failed = true;
            break;
          } else {
            if ( isVideoFile(line) ) {
              var ParsedURL = new URL(line);
              var FileName = unescape(ParsedURL.pathname.split('/').pop());
              var allow = true;
              var title = false;
              if ( options.parseFileNames ) {
                var ParsedName = parseVideoName(unescape(FileName));
                
                // Only Allow Parsable File Names
                if ( options.onlyAllowParsable && ParsedName.name == undefined ) {
                  allow = false;
                }
                
                // Remove Duplicates is Dependant on File Name Parsing, Only applies if the YEAR is specified.
                if ( options.removeDuplicates.enable && (options.removeDuplicates.onlyAllowYear && ParsedName.year || true) ) {
                  var SecureName = ParsedName.name;
                  if ( options.removeDuplicates.onlyAllowYear ) {
                    SecureName = ParsedName.name + ParsedName.year;
                  }
                  if ( duplicates[SecureName]  ) {
                    allow = false;
                  } else {
                    duplicates[SecureName] = 0;
                  }
                  duplicates[SecureName]++;
                }
                
                // Add Parsed Titles:
                if ( options.addTitles && ParsedName.name != undefined ) {
									if ( ParsedName.type == 'movie' ) {
										title = titleCase(ParsedName.name) + (ParsedName.year && ' (' + ParsedName.year + ')' || '');
									} else if ( ParsedName.type == 'series' ) { 
										title = titleCase(ParsedName.name) + (ParsedName.year && ' (' + ParsedName.year + ')' || '') + (ParsedName.season && ' S' + ParsedName.season) + (ParsedName.episode && ' E' + ParsedName.episode)
									}
                }
              }
              if ( allow ) {
                files.push({id:i, title: title, url:(ParsedURL.origin + escape(unescape(ParsedURL.pathname)))});
              }
            }
          }
        }
        if ( failed ) {
          toastr.error('Woah, those links dont appear to be links!?');
        } else {
          toastr.info('Filtered out '+(lines.length - files.length)+' duplicates.');
          toastr.info('Links are Valid... Trying to render file.');
          render(files);
        }
      }
      
      Mustache.escape = function(content){ return content; }
      
      function render(files){
        var data = {
          files: files,
          total: files.length
        };
        
        var rendered = Mustache.render(template.html(), data);
        downloade(data.total+' Links.xspf', rendered)
        toastr.success('Success! Download the file.');
      }
      
      function isVideoFile(file){
        return (file.match(/\.(mp4|avi|mkv)$/) && true || false);
      }
      
      function titleCase(str) {
        return str.replace(/(^|\s)\S/g, function(t) { return t.toUpperCase() });
      }
      
      function getLocation(href) {
        var l = document.createElement("a");
        l.href = href;
        return l;
      }
      
      function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
      }
      
      function downloade (filename, data) {
        var blob = new Blob([data], {type: 'application/xspf+xml'});
        if(window.navigator.msSaveOrOpenBlob) {
          window.navigator.msSaveBlob(blob, filename);
        }
        else{
          var elem = window.document.createElement('a');
          elem.href = window.URL.createObjectURL(blob);
          elem.download = filename;        
          document.body.appendChild(elem);
          elem.click();        
          document.body.removeChild(elem);
        }
      }
      
      window.isValidURL = (function() {// wrapped in self calling function to prevent global pollution
				 //URL pattern based on rfc1738 and rfc3986
				var rg_pctEncoded = "%[0-9a-fA-F]{2}";
				var rg_protocol = "(http|https):\\/\\/";

				var rg_userinfo = "([a-zA-Z0-9$\\-_.+!*'(),;:&=]|" + rg_pctEncoded + ")+" + "@";

				var rg_decOctet = "(25[0-5]|2[0-4][0-9]|[0-1][0-9][0-9]|[1-9][0-9]|[0-9])"; // 0-255
				var rg_ipv4address = "(" + rg_decOctet + "(\\." + rg_decOctet + "){3}" + ")";
				var rg_hostname = "([a-zA-Z0-9\\-\\u00C0-\\u017F]+\\.)+([a-zA-Z]{2,})";
				var rg_port = "[0-9]+";

				var rg_hostport = "(" + rg_ipv4address + "|localhost|" + rg_hostname + ")(:" + rg_port + ")?";

				// chars sets
				// safe           = "$" | "-" | "_" | "." | "+"
				// extra          = "!" | "*" | "'" | "(" | ")" | ","
				// hsegment       = *[ alpha | digit | safe | extra | ";" | ":" | "@" | "&" | "=" | escape ]
				var rg_pchar = "a-zA-Z0-9$\\-_.+!*'(),;:@&=";
				var rg_segment = "([" + rg_pchar + "]|" + rg_pctEncoded + ")*";

				var rg_path = rg_segment + "(\\/" + rg_segment + ")*";
				var rg_query = "\\?" + "([" + rg_pchar + "/?]|" + rg_pctEncoded + ")*";
				var rg_fragment = "\\#" + "([" + rg_pchar + "/?]|" + rg_pctEncoded + ")*";

				var rgHttpUrl = new RegExp( 
						"^"
						+ rg_protocol
						+ "(" + rg_userinfo + ")?"
						+ rg_hostport
						+ "(\\/"
						+ "(" + rg_path + ")?"
						+ "(" + rg_query + ")?"
						+ "(" + rg_fragment + ")?"
						+ ")?"
						+ "$"
				);

				// export public function
				return function (url) {
						if (rgHttpUrl.test(url)) {
								return true;
						} else {
								return false;
						}
				};
		})();
    </script>
  </body>
</html>
